"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Collector = void 0;
const TypedEventEmitter_1 = __importDefault(require("./TypedEventEmitter"));
/** A base collector class to be extended from. */
class Collector extends TypedEventEmitter_1.default {
    /**
     * @param options The collector options.
     */
    constructor(options = {}) {
        super();
        this.options = options;
        this.idleTimeout = null;
        this.max = null;
        this.timeout = null;
        this.endReason = null;
        /** An array of all the data collected. */
        this.collected = [];
        /** Whether this collector has stopped collecting. */
        this.ended = false;
        this.filter = options.filter ?? (() => true);
        if (options.time)
            this.timeout = setTimeout(() => this.stop('time'), options.time).unref();
        if (options.idle)
            this.idleTimeout = setTimeout(() => this.stop('idle'), options.idle).unref();
        if (options.max)
            this.max = options.max;
        this.handleCollect = this.handleCollect.bind(this);
        this.handleDispose = this.handleDispose.bind(this);
    }
    collect(...args) {
        return args;
    }
    ;
    dispose(...args) {
        return args;
    }
    ;
    /**
     * Call this to handle an event as a collectable element.
     * @param toHandle The data to handle as an element.
     */
    async handleCollect(toHandle) {
        const collected = await this.collect(toHandle);
        if (collected) {
            const filterResult = await this.filter(collected);
            if (filterResult) {
                this.collected.push(collected);
                this.emit('collect', collected);
                if (this.idleTimeout) {
                    clearTimeout(this.idleTimeout);
                    this.idleTimeout = setTimeout(() => this.stop('idle'), this.options.idle).unref();
                }
                if (this.max && this.collected.length >= this.max)
                    this.stop('limit');
            }
            else {
                this.emit('ignore', collected);
            }
        }
        this.checkEnd();
    }
    /**
     * Call this to remove an element from the collection.
     * @param collected The collected element to dispose.
     */
    async handleDispose(collected) {
        if (!this.options.dispose)
            return;
        const dispose = await this.dispose(collected);
        if (!dispose || !(await this.filter(dispose)) || !this.collected.includes(dispose))
            return;
        this.collected.splice(this.collected.indexOf(dispose), 1);
        this.emit('dispose', dispose);
        this.checkEnd();
    }
    /** A promise that resolves whenever the next data is collected. */
    get next() {
        return new Promise((resolve, reject) => {
            if (this.ended) {
                reject(this.collected);
                return;
            }
            const cleanup = () => {
                this.removeListener('collect', onCollect);
                this.removeListener('end', onEnd);
            };
            const onCollect = (collected) => {
                cleanup();
                resolve(collected);
            };
            const onEnd = () => {
                cleanup();
                reject(this.collected);
            };
            this.on('collect', onCollect);
            this.on('end', onEnd);
        });
    }
    async *[Symbol.asyncIterator]() {
        const queue = [];
        const onCollect = (collected) => queue.push(collected);
        this.on('collect', onCollect);
        try {
            while (queue.length || !this.ended) {
                if (queue.length) {
                    yield queue.shift();
                }
                else {
                    await new Promise((resolve) => {
                        const tick = () => {
                            this.removeListener('collect', tick);
                            this.removeListener('end', tick);
                            return resolve();
                        };
                        this.on('collect', tick);
                        this.on('end', tick);
                    });
                }
            }
        }
        finally {
            this.removeListener('collect', onCollect);
        }
    }
    /** Check whether this collector should have ended. */
    checkEnd() {
        const reason = this.endReason;
        if (reason)
            this.stop(reason);
        return Boolean(reason);
    }
    /** Empty the collected data of this collector. */
    empty() {
        this.collected = [];
        this.checkEnd();
    }
    /**
     * Reset the time to end this collector.
     * @param options The options to reset the timer.
     */
    resetTimer({ time, idle } = {}) {
        if (this.timeout) {
            clearTimeout(this.timeout);
            this.timeout = setTimeout(() => this.stop('time'), time ?? this.options.time).unref();
        }
        if (this.idleTimeout) {
            clearTimeout(this.idleTimeout);
            this.idleTimeout = setTimeout(() => this.stop('idle'), idle ?? this.options.idle).unref();
        }
    }
    /**
     * Stop this collector.
     * @param reason The reason to stop this collector. Defaults to "user".
     */
    stop(reason = 'user') {
        if (this.ended)
            return;
        if (this.timeout) {
            clearTimeout(this.timeout);
            this.timeout = null;
        }
        if (this.idleTimeout) {
            clearTimeout(this.idleTimeout);
            this.idleTimeout = null;
        }
        this.endReason = reason;
        this.ended = true;
        this.emit('end', this.collected, reason);
    }
}
exports.Collector = Collector;
exports.default = Collector;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29sbGVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N0cnVjdHVyZXMvQ29sbGVjdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLDRFQUFtRDtBQXVEbkQsa0RBQWtEO0FBQ2xELE1BQXNCLFNBQXdDLFNBQVEsMkJBQWtFO0lBeUJwSTs7T0FFRztJQUNILFlBQTBCLFVBQStCLEVBQUU7UUFDdkQsS0FBSyxFQUFFLENBQUE7UUFEZSxZQUFPLEdBQVAsT0FBTyxDQUEwQjtRQTNCbkQsZ0JBQVcsR0FBMEIsSUFBSSxDQUFBO1FBQ3pDLFFBQUcsR0FBa0IsSUFBSSxDQUFBO1FBQ3pCLFlBQU8sR0FBMEIsSUFBSSxDQUFBO1FBRW5DLGNBQVMsR0FBdUMsSUFBSSxDQUFBO1FBRTlELDBDQUEwQztRQUNuQyxjQUFTLEdBQVEsRUFBRSxDQUFBO1FBQzFCLHFEQUFxRDtRQUM5QyxVQUFLLEdBQUcsS0FBSyxDQUFBO1FBcUJoQixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxHQUFTLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVsRCxJQUFJLE9BQU8sQ0FBQyxJQUFJO1lBQUUsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDMUYsSUFBSSxPQUFPLENBQUMsSUFBSTtZQUFFLElBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQzlGLElBQUksT0FBTyxDQUFDLEdBQUc7WUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQyxH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QyxXQUFXLENBQUMsQ0FBQTtZQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLElBQUksSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFBO1NBQzVGO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNJLElBQUksQ0FBQyxTQUFzQyxNQUFNO1FBQ3BELElBQUksSUFBSSxDQUFDLEtBQUs7WUFBRSxPQUFNO1FBRXRCLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNkLFlBQVksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7WUFDMUIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUE7U0FDdEI7UUFDRCxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDbEIsWUFBWSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUM5QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQTtTQUMxQjtRQUVELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFBO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFBO1FBRWpCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDNUMsQ0FBQztDQUNKO0FBN0xELDhCQTZMQztBQUVELGtCQUFlLFNBQVMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUeXBlZEV2ZW50RW1pdHRlciBmcm9tICcuL1R5cGVkRXZlbnRFbWl0dGVyJ1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDb2xsZWN0b3JFdmVudHM8VCwgViBleHRlbmRzIHN0cmluZyB8IEJhc2VDb2xsZWN0b3JFbmRSZWFzb25zPiB7XHJcbiAgICAvKipcclxuICAgICAqIEVtaXR0ZWQgd2hlbmV2ZXIgc29tZXRoaW5nIGlzIGNvbGxlY3RlZC5cclxuICAgICAqIEBwYXJhbSBjb2xsZWN0ZWQgVGhlIGVsZW1lbnQgY29sbGVjdGVkLlxyXG4gICAgICovXHJcbiAgICBjb2xsZWN0KGNvbGxlY3RlZDogVCk6IGFueVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRW1pdHRlZCB3aGVuZXZlciBzb21ldGhpbmcgaXMgZGlzcG9zZWQuXHJcbiAgICAgKiBAcGFyYW0gZGlzcG9zZWQgVGhlIGVsZW1lbnQgZGlzcG9zZWQuXHJcbiAgICAgKi9cclxuICAgIGRpc3Bvc2UoZGlzcG9zZWQ6IGFueSk6IGFueVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRW1pdHRlZCB3aGVuZXZlciBzb21ldGhpbmcgaXMgaWdub3JlZC5cclxuICAgICAqIEBwYXJhbSBpZ25vcmVkIFRoZSBlbGVtZW50IGlnbm9yZWQuXHJcbiAgICAgKi9cclxuICAgIGlnbm9yZShpZ25vcmVkOiBUKTogYW55XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFbWl0dGVkIHdoZW5ldmVyIHRoZSBjb2xsZWN0b3Igc3RvcHMgY29sbGVjdGluZy5cclxuICAgICAqIEBwYXJhbSBjb2xsZWN0ZWQgVGhlIGRhdGEgY29sbGVjdGVkIGJ5IHRoZSBjb2xsZWN0b3IuXHJcbiAgICAgKiBAcGFyYW0gcmVhc29uIFRoZSByZWFzb24gdGhlIGNvbGxlY3RvciBoYXMgZW5kZWQuXHJcbiAgICAgKi9cclxuICAgIGVuZChjb2xsZWN0ZWQ6IFRbXSwgcmVhc29uOiBWKTogYW55XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQ29sbGVjdG9yT3B0aW9uczxUPiB7XHJcbiAgICAvKiogV2hldGhlciB0byBkaXNwb3NlIGRhdGEgd2hlbiBpdCdzIGRlbGV0ZWQuICovXHJcbiAgICBkaXNwb3NlPzogYm9vbGVhbjtcclxuICAgIC8qKiBIb3cgbG9uZyB0byBzdG9wIHRoZSBjb2xsZWN0b3IgYWZ0ZXIgaW5hY3Rpdml0eSBpbiBtaWxsaXNlY29uZHMuICovXHJcbiAgICBpZGxlPzogbnVtYmVyO1xyXG4gICAgLyoqIFRoZSBtYXhpbXVtIHRvdGFsIGFtb3VudCBvZiBkYXRhIHRvIGNvbGxlY3QuICovXHJcbiAgICBtYXg/OiBudW1iZXI7XHJcbiAgICAvKiogSG93IGxvbmcgdG8gcnVuIHRoZSBjb2xsZWN0b3IgZm9yIGluIG1pbGxpc2Vjb25kcy4gKi9cclxuICAgIHRpbWU/OiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgZmlsdGVyIGFwcGxpZWQgdG8gdGhpcyBjb2xsZWN0b3IuXHJcbiAgICAgKiBAcGFyYW0gY29sbGV0ZWQgVGhlIGNvbGxlY3RlZCBlbGVtZW50IHRvIGZpbHRlci5cclxuICAgICAqL1xyXG4gICAgZmlsdGVyPyhjb2xsZXRlZDogVCk6IGJvb2xlYW4gfCBQcm9taXNlPGJvb2xlYW4+XHJcbn1cclxuXHJcbmludGVyZmFjZSBSZXNldFRpbWVyT3B0aW9ucyB7XHJcbiAgICAvKiogSG93IGxvbmcgdG8gc3RvcCB0aGUgY29sbGVjdG9yIGFmdGVyIGluYWN0aXZpdHkgaW4gbWlsbGlzZWNvbmRzLiAqL1xyXG4gICAgaWRsZT86IG51bWJlcjtcclxuICAgIC8qKiBIb3cgbG9uZyB0byBydW4gdGhlIGNvbGxlY3RvciBmb3IgaW4gbWlsbGlzZWNvbmRzLiAqL1xyXG4gICAgdGltZT86IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgQmFzZUNvbGxlY3RvckVuZFJlYXNvbnMgPSAndGltZScgfCAnaWRsZScgfCAnbGltaXQnIHwgJ3VzZXInXHJcblxyXG4vKiogQSBiYXNlIGNvbGxlY3RvciBjbGFzcyB0byBiZSBleHRlbmRlZCBmcm9tLiAqL1xyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQ29sbGVjdG9yPFQsIFYgZXh0ZW5kcyBzdHJpbmcgPSBzdHJpbmc+IGV4dGVuZHMgVHlwZWRFdmVudEVtaXR0ZXI8Q29sbGVjdG9yRXZlbnRzPFQsIFYgfCBCYXNlQ29sbGVjdG9yRW5kUmVhc29ucz4+IHtcclxuICAgIHByaXZhdGUgaWRsZVRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGxcclxuICAgIHByaXZhdGUgbWF4OiBudW1iZXIgfCBudWxsID0gbnVsbFxyXG4gICAgcHJpdmF0ZSB0aW1lb3V0OiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsXHJcblxyXG4gICAgcHJvdGVjdGVkIGVuZFJlYXNvbjogViB8IEJhc2VDb2xsZWN0b3JFbmRSZWFzb25zIHwgbnVsbCA9IG51bGxcclxuXHJcbiAgICAvKiogQW4gYXJyYXkgb2YgYWxsIHRoZSBkYXRhIGNvbGxlY3RlZC4gKi9cclxuICAgIHB1YmxpYyBjb2xsZWN0ZWQ6IFRbXSA9IFtdXHJcbiAgICAvKiogV2hldGhlciB0aGlzIGNvbGxlY3RvciBoYXMgc3RvcHBlZCBjb2xsZWN0aW5nLiAqL1xyXG4gICAgcHVibGljIGVuZGVkID0gZmFsc2VcclxuICAgIC8qKlxyXG4gICAgICogVGhlIGZpbHRlciBhcHBsaWVkIHRvIHRoaXMgY29sbGVjdG9yLlxyXG4gICAgICogQHBhcmFtIGNvbGxldGVkIFRoZSBjb2xsZWN0ZWQgZWxlbWVudCB0byBmaWx0ZXIuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBmaWx0ZXI6IChjb2xsZWN0ZWQ6IFQpID0+IGJvb2xlYW4gfCBQcm9taXNlPGJvb2xlYW4+XHJcblxyXG4gICAgcHJvdGVjdGVkIGNvbGxlY3QoLi4uYXJnczogYW55W10pOiBhbnkge1xyXG4gICAgICAgIHJldHVybiBhcmdzXHJcbiAgICB9O1xyXG5cclxuICAgIHByb3RlY3RlZCBkaXNwb3NlKC4uLmFyZ3M6IGFueVtdKTogYW55IHtcclxuICAgICAgICByZXR1cm4gYXJnc1xyXG4gICAgfTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEBwYXJhbSBvcHRpb25zIFRoZSBjb2xsZWN0b3Igb3B0aW9ucy5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRpb25zOiBDb2xsZWN0b3JPcHRpb25zPFQ+ID0ge30pIHtcclxuICAgICAgICBzdXBlcigpXHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyID0gb3B0aW9ucy5maWx0ZXIgPz8gKCgpOiB0cnVlID0+IHRydWUpXHJcblxyXG4gICAgICAgIGlmIChvcHRpb25zLnRpbWUpIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5zdG9wKCd0aW1lJyksIG9wdGlvbnMudGltZSkudW5yZWYoKVxyXG4gICAgICAgIGlmIChvcHRpb25zLmlkbGUpIHRoaXMuaWRsZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHRoaXMuc3RvcCgnaWRsZScpLCBvcHRpb25zLmlkbGUpLnVucmVmKClcclxuICAgICAgICBpZiAob3B0aW9ucy5tYXgpIHRoaXMubWF4ID0gb3B0aW9ucy5tYXhcclxuXHJcbiAgICAgICAgdGhpcy5oYW5kbGVDb2xsZWN0ID0gdGhpcy5oYW5kbGVDb2xsZWN0LmJpbmQodGhpcylcclxuICAgICAgICB0aGlzLmhhbmRsZURpc3Bvc2UgPSB0aGlzLmhhbmRsZURpc3Bvc2UuYmluZCh0aGlzKVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2FsbCB0aGlzIHRvIGhhbmRsZSBhbiBldmVudCBhcyBhIGNvbGxlY3RhYmxlIGVsZW1lbnQuXHJcbiAgICAgKiBAcGFyYW0gdG9IYW5kbGUgVGhlIGRhdGEgdG8gaGFuZGxlIGFzIGFuIGVsZW1lbnQuXHJcbiAgICAgKi9cclxuICAgIHB1YmxpYyBhc3luYyBoYW5kbGVDb2xsZWN0KHRvSGFuZGxlOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCBjb2xsZWN0ZWQgPSBhd2FpdCB0aGlzLmNvbGxlY3QodG9IYW5kbGUpXHJcblxyXG4gICAgICAgIGlmIChjb2xsZWN0ZWQpIHtcclxuICAgICAgICAgICAgY29uc3QgZmlsdGVyUmVzdWx0ID0gYXdhaXQgdGhpcy5maWx0ZXIoY29sbGVjdGVkKVxyXG5cclxuICAgICAgICAgICAgaWYgKGZpbHRlclJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2xsZWN0ZWQucHVzaChjb2xsZWN0ZWQpXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ2NvbGxlY3QnLCBjb2xsZWN0ZWQpXHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaWRsZVRpbWVvdXQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5pZGxlVGltZW91dClcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlkbGVUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLnN0b3AoJ2lkbGUnKSwgdGhpcy5vcHRpb25zLmlkbGUpLnVucmVmKClcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5tYXggJiYgdGhpcy5jb2xsZWN0ZWQubGVuZ3RoID49IHRoaXMubWF4KSB0aGlzLnN0b3AoJ2xpbWl0JylcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnaWdub3JlJywgY29sbGVjdGVkKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmNoZWNrRW5kKClcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGwgdGhpcyB0byByZW1vdmUgYW4gZWxlbWVudCBmcm9tIHRoZSBjb2xsZWN0aW9uLlxyXG4gICAgICogQHBhcmFtIGNvbGxlY3RlZCBUaGUgY29sbGVjdGVkIGVsZW1lbnQgdG8gZGlzcG9zZS5cclxuICAgICAqL1xyXG4gICAgcHVibGljIGFzeW5jIGhhbmRsZURpc3Bvc2UoY29sbGVjdGVkOiBhbnkpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5kaXNwb3NlKSByZXR1cm5cclxuXHJcbiAgICAgICAgY29uc3QgZGlzcG9zZSA9IGF3YWl0IHRoaXMuZGlzcG9zZShjb2xsZWN0ZWQpXHJcblxyXG4gICAgICAgIGlmICghZGlzcG9zZSB8fCAhKGF3YWl0IHRoaXMuZmlsdGVyKGRpc3Bvc2UpKSB8fCAhdGhpcy5jb2xsZWN0ZWQuaW5jbHVkZXMoZGlzcG9zZSkpIHJldHVyblxyXG5cclxuICAgICAgICB0aGlzLmNvbGxlY3RlZC5zcGxpY2UodGhpcy5jb2xsZWN0ZWQuaW5kZXhPZihkaXNwb3NlKSwgMSlcclxuICAgICAgICB0aGlzLmVtaXQoJ2Rpc3Bvc2UnLCBkaXNwb3NlKVxyXG5cclxuICAgICAgICB0aGlzLmNoZWNrRW5kKClcclxuICAgIH1cclxuXHJcbiAgICAvKiogQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgd2hlbmV2ZXIgdGhlIG5leHQgZGF0YSBpcyBjb2xsZWN0ZWQuICovXHJcbiAgICBwdWJsaWMgZ2V0IG5leHQoKTogUHJvbWlzZTxUPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZW5kZWQpIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdCh0aGlzLmNvbGxlY3RlZClcclxuICAgICAgICAgICAgICAgIHJldHVyblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjbGVhbnVwID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignY29sbGVjdCcsIG9uQ29sbGVjdClcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ2VuZCcsIG9uRW5kKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBvbkNvbGxlY3QgPSAoY29sbGVjdGVkOiBUKTogdm9pZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjbGVhbnVwKClcclxuICAgICAgICAgICAgICAgIHJlc29sdmUoY29sbGVjdGVkKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBvbkVuZCA9ICgpOiB2b2lkID0+IHtcclxuICAgICAgICAgICAgICAgIGNsZWFudXAoKVxyXG4gICAgICAgICAgICAgICAgcmVqZWN0KHRoaXMuY29sbGVjdGVkKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLm9uKCdjb2xsZWN0Jywgb25Db2xsZWN0KVxyXG4gICAgICAgICAgICB0aGlzLm9uKCdlbmQnLCBvbkVuZClcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhc3luYyogW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpOiBBc3luY0dlbmVyYXRvcjxBd2FpdGVkPFQgfCB1bmRlZmluZWQ+PiB7XHJcbiAgICAgICAgY29uc3QgcXVldWU6IFRbXSA9IFtdXHJcbiAgICAgICAgY29uc3Qgb25Db2xsZWN0ID0gKGNvbGxlY3RlZDogVCk6IG51bWJlciA9PiBxdWV1ZS5wdXNoKGNvbGxlY3RlZClcclxuICAgICAgICB0aGlzLm9uKCdjb2xsZWN0Jywgb25Db2xsZWN0KVxyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICB3aGlsZSAocXVldWUubGVuZ3RoIHx8ICF0aGlzLmVuZGVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocXVldWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgcXVldWUuc2hpZnQoKVxyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aWNrID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcignY29sbGVjdCcsIHRpY2spXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdlbmQnLCB0aWNrKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub24oJ2NvbGxlY3QnLCB0aWNrKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uKCdlbmQnLCB0aWNrKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKCdjb2xsZWN0Jywgb25Db2xsZWN0KVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiogQ2hlY2sgd2hldGhlciB0aGlzIGNvbGxlY3RvciBzaG91bGQgaGF2ZSBlbmRlZC4gKi9cclxuICAgIHB1YmxpYyBjaGVja0VuZCgpOiBib29sZWFuIHtcclxuICAgICAgICBjb25zdCByZWFzb24gPSB0aGlzLmVuZFJlYXNvblxyXG4gICAgICAgIGlmIChyZWFzb24pIHRoaXMuc3RvcChyZWFzb24pXHJcbiAgICAgICAgcmV0dXJuIEJvb2xlYW4ocmVhc29uKVxyXG4gICAgfVxyXG5cclxuICAgIC8qKiBFbXB0eSB0aGUgY29sbGVjdGVkIGRhdGEgb2YgdGhpcyBjb2xsZWN0b3IuICovXHJcbiAgICBwdWJsaWMgZW1wdHkoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jb2xsZWN0ZWQgPSBbXVxyXG4gICAgICAgIHRoaXMuY2hlY2tFbmQoKVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogUmVzZXQgdGhlIHRpbWUgdG8gZW5kIHRoaXMgY29sbGVjdG9yLlxyXG4gICAgICogQHBhcmFtIG9wdGlvbnMgVGhlIG9wdGlvbnMgdG8gcmVzZXQgdGhlIHRpbWVyLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgcmVzZXRUaW1lcih7IHRpbWUsIGlkbGUgfTogUmVzZXRUaW1lck9wdGlvbnMgPSB7fSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnRpbWVvdXQpIHtcclxuICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dClcclxuICAgICAgICAgICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLnN0b3AoJ3RpbWUnKSwgdGltZSA/PyB0aGlzLm9wdGlvbnMudGltZSkudW5yZWYoKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5pZGxlVGltZW91dCkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5pZGxlVGltZW91dClcclxuICAgICAgICAgICAgdGhpcy5pZGxlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5zdG9wKCdpZGxlJyksIGlkbGUgPz8gdGhpcy5vcHRpb25zLmlkbGUpLnVucmVmKClcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBTdG9wIHRoaXMgY29sbGVjdG9yLlxyXG4gICAgICogQHBhcmFtIHJlYXNvbiBUaGUgcmVhc29uIHRvIHN0b3AgdGhpcyBjb2xsZWN0b3IuIERlZmF1bHRzIHRvIFwidXNlclwiLlxyXG4gICAgICovXHJcbiAgICBwdWJsaWMgc3RvcChyZWFzb246IFYgfCBCYXNlQ29sbGVjdG9yRW5kUmVhc29ucyA9ICd1c2VyJyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmVuZGVkKSByZXR1cm5cclxuXHJcbiAgICAgICAgaWYgKHRoaXMudGltZW91dCkge1xyXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KVxyXG4gICAgICAgICAgICB0aGlzLnRpbWVvdXQgPSBudWxsXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmlkbGVUaW1lb3V0KSB7XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmlkbGVUaW1lb3V0KVxyXG4gICAgICAgICAgICB0aGlzLmlkbGVUaW1lb3V0ID0gbnVsbFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5lbmRSZWFzb24gPSByZWFzb25cclxuICAgICAgICB0aGlzLmVuZGVkID0gdHJ1ZVxyXG5cclxuICAgICAgICB0aGlzLmVtaXQoJ2VuZCcsIHRoaXMuY29sbGVjdGVkLCByZWFzb24pXHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IENvbGxlY3RvclxyXG4iXX0=